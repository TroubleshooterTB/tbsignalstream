rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User credentials (existing)
    match /user_credentials/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Angel One credentials (existing)
    match /angel_one_credentials/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Live tick data - real-time WebSocket data
    match /live_ticks/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Order history - all placed orders
    match /orders/{userId}/order_history/{orderId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Trading positions - open positions
    match /trading_positions/{userId}/open/{symbol} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Trading positions - historical trades
    match /trading_positions/{userId}/history/{tradeId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Historical data - cached OHLCV candles (read-only for users, write for Cloud Functions)
    match /historical_data/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // Only Cloud Functions can write
    }
    
    // Trading signals - bot-generated signals
    match /trading_signals/{signalId} {
      allow read: if request.auth != null && resource.data.user_id == request.auth.uid;
      allow write: if request.auth != null; // Bot can create signals for user
      allow delete: if request.auth != null && resource.data.user_id == request.auth.uid;
    }
    
    // Signals collection - alternative collection name
    match /signals/{signalId} {
      allow read: if request.auth != null && (resource.data.user_id == request.auth.uid || resource.data.userId == request.auth.uid);
      allow write: if request.auth != null; // Bot can create signals for user
      allow delete: if request.auth != null && (resource.data.user_id == request.auth.uid || resource.data.userId == request.auth.uid);
    }
    
    // Replay results - replay simulation outcomes
    match /replay_results/{resultId} {
      allow read: if request.auth != null && resultId.matches('^' + request.auth.uid + '_.*');
      allow write: if request.auth != null; // Bot can create results
      allow delete: if request.auth != null && resultId.matches('^' + request.auth.uid + '_.*');
    }
    
    // Bot configurations - per-user settings
    match /bot_configs/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Bot status - real-time bot performance and regime data
    match /bot_status/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Bot activity - real-time analysis feed
    match /bot_activity/{activityId} {
      allow read: if request.auth != null && resource.data.user_id == request.auth.uid;
      allow write: if request.auth != null; // Bot can create activity logs
      allow delete: if request.auth != null && resource.data.user_id == request.auth.uid;
    }
    
    // Backtest results - strategy testing history
    match /backtest_results/{resultId} {
      allow read: if true; // Everyone can read (or restrict to authenticated users)
      allow write: if true; // Allow writes (or restrict to authenticated users)
      allow delete: if true; // Allow deletion (or restrict)
    }
  }
}
